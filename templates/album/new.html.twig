{% extends 'base.html.twig' %}

{% block title %}Nouvel album{% endblock %}

{% block body %}
<main class="container my-5">

    <div class="comic-card mx-auto p-4 shadow-lg rounded-4">

        {# --- Titre façon BD --- #}
        <h1 class="comic-title text-center mb-4">
            Nouvel album
        </h1>

        {{ form_start(form, {'attr': {'enctype': 'multipart/form-data'}}) }}

        {# --- Titre --- #}
        <div class="comic-bubble mb-3">
            {{ form_label(form.titre, null, {'label_attr': {'class': 'fw-bold'}}) }}
            {{ form_widget(form.titre, {'attr': {'class': 'form-control mt-2'}}) }}
            {{ form_errors(form.titre) }}
        </div>

        {# --- Numéro --- #}
        <div class="comic-bubble mb-3">
            {{ form_label(form.numero, null, {'label_attr': {'class': 'fw-bold'}}) }}
            {{ form_widget(form.numero, {'attr': {'class': 'form-control mt-2'}}) }}
            {{ form_errors(form.numero) }}
        </div>

        {# --- Série --- #}
        <div class="comic-bubble mb-3">
            {{ form_label(form.serie, null, {'label_attr': {'class': 'fw-bold'}}) }}
            {{ form_widget(form.serie, {'attr': {'class': 'form-control mt-2'}}) }}
            {{ form_errors(form.serie) }}
        </div>

        {# --- Couverture avec prévisualisation --- #}
<div class="comic-bubble mb-3">
    {{ form_label(form.couverture, null, {'label_attr': {'class': 'fw-bold'}}) }}

    {# Champ "Parcourir" #}
    {{ form_widget(form.couverture, {'attr': {'class': 'form-control mt-2', 'id': 'album_image_input', 'accept': 'image/*'}}) }}
    {{ form_errors(form.couverture) }}

    {# Miniature sous le champ #}
    {% if album.couverture %}
        <img id="previewImage" src="{{ asset('uploads/' ~ album.couverture) }}" 
             alt="Miniature couverture" class="img-fluid mt-2" style="max-height: 150px;">
    {% else %}
        <img id="previewImage" src="#" alt="Miniature couverture" 
             class="img-fluid mt-2" style="display:none; max-height: 150px;">
    {% endif %}

    <div id="fileName" class="mt-1" style="font-style: italic; color:#555;"></div>
</div>

        {# --- Boutons --- #}
        <div class="d-flex gap-2 flex-wrap mt-4">
            <button type="submit" class="comic-action-btn">Créer</button>
            <a href="{{ path('app_serie_index') }}" class="comic-action-btn">Retour</a>
        </div>

        {{ form_end(form) }}

    </div>

</main>

{# --- Script pour prévisualisation image --- #}
<script>
document.addEventListener('DOMContentLoaded', () => {
    const container = document.querySelector('.comic-card') || document;
    let fileInput = document.getElementById('album_image_input');
    const fallback = container.querySelector('input[type="file"]');
    if (!fileInput && fallback) {
        fileInput = fallback;
        console.warn('album_image_input introuvable — utilisation du premier input[type="file"] trouvé dans .comic-card.');
    }

    const preview = document.getElementById('previewImage');
    const fileName = document.getElementById('fileName');

    if (!fileInput) {
        console.error('Aucun input[type="file"] trouvé. Inspectez le HTML rendu pour vérifier l\'id/name du champ.');
        // pour debug rapide : affiche le début du HTML du container
        console.log('Container HTML (début):', container.innerHTML.slice(0, 800));
        return;
    }
    if (!preview) {
        console.error('Elément #previewImage introuvable.');
        return;
    }

    // si le preview a src="#" on le vide pour éviter requêtes inutiles
    if (preview.getAttribute('src') === '#') preview.src = '';

    fileInput.addEventListener('change', () => {
        const f = fileInput.files && fileInput.files[0];
        if (f) {
            fileName.textContent = `Fichier sélectionné : ${f.name}`;
            const reader = new FileReader();
            reader.onload = (e) => {
                preview.src = e.target.result;
                preview.style.display = 'block';
            };
            reader.readAsDataURL(f);
        } else {
            fileName.textContent = 'Aucun fichier choisi';
            preview.style.display = 'none';
            preview.src = '';
        }
    });

    // debug : vérifier que l'événement change est bien attaché
    console.log('Preview ready — input:', fileInput, 'preview:', preview);
});
</script>
{% endblock %}
