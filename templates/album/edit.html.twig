{% extends 'base.html.twig' %}

{% block title %}Modifier l'album{% endblock %}

{% block body %}
<main class="container my-5">

    <div class="comic-card mx-auto p-4 shadow-lg rounded-4">

        <h1 class="comic-title text-center mb-4">Modifier l'album</h1>

        {{ form_start(form, {'attr': {'enctype': 'multipart/form-data'}}) }}

        {# --- Titre --- #}
        <div class="comic-bubble mb-3">
            {{ form_label(form.titre, null, {'label_attr': {'class': 'fw-bold'}}) }}
            {{ form_widget(form.titre, {'attr': {'class': 'form-control mt-2'}}) }}
            {{ form_errors(form.titre) }}
        </div>

        {# --- Numéro --- #}
        <div class="comic-bubble mb-3">
            {{ form_label(form.numero, null, {'label_attr': {'class': 'fw-bold'}}) }}
            {{ form_widget(form.numero, {'attr': {'class': 'form-control mt-2'}}) }}
            {{ form_errors(form.numero) }}
        </div>

        {# --- Série --- #}
        <div class="comic-bubble mb-3">
            {{ form_label(form.serie, null, {'label_attr': {'class': 'fw-bold'}}) }}
            {{ form_widget(form.serie, {'attr': {'class': 'form-control mt-2'}}) }}
            {{ form_errors(form.serie) }}
        </div>

        {# --- Couverture avec prévisualisation --- #}
        <div class="comic-bubble mb-3">
            {{ form_label(form.couverture, null, {'label_attr': {'class': 'fw-bold'}}) }}
            {{ form_widget(form.couverture, {'attr': {'class': 'form-control mt-2', 'id': 'album_image_input', 'accept': 'image/*'}}) }}
            {{ form_errors(form.couverture) }}

            {% if album.couverture %}
                <img id="previewImage"
                     src="{{ asset('uploads/' ~ album.couverture) }}?v={{ album.couvertureUpdatedAt ? album.couvertureUpdatedAt|date('YmdHis') : '0' }}"
                     alt="Miniature couverture"
                     class="img-fluid mt-2"
                     style="max-height: 150px;">
            {% else %}
                <img id="previewImage" src="#" alt="Miniature couverture"
                     class="img-fluid mt-2" style="display:none; max-height: 150px;">
            {% endif %}

            <div id="fileName" class="mt-1" style="font-style: italic; color:#555;"></div>
        </div>

        <div class="d-flex gap-2 flex-wrap mt-4">
            <button type="submit" class="comic-action-btn">Enregistrer les modifications</button>
        </div>

        {{ form_end(form) }}

        <br>

        {# --- Lu / Non lu --- #}
        <div class="comic-bubble mb-3 d-flex flex-column flex-md-row justify-content-between align-items-md-center gap-2">
            <div>
                <strong>Statut :</strong>
                {% if album.lu %}
                    ✔️ <span class="text-success fw-bold">Lu</span>
                {% else %}
                    ❌ <span class="text-danger fw-bold">Non lu</span>
                {% endif %}
            </div>

            <form method="post" action="{{ path('app_album_toggle_lu', {'id': album.id}) }}" class="m-0">
                <input type="hidden" name="_token" value="{{ csrf_token('toggle_lu' ~ album.id) }}">
                <input type="hidden" name="redirect" value="edit">
                <button class="comic-action-btn py-1 px-3">Changer le statut</button>
            </form>
        </div>

        <div class="d-flex gap-2 flex-wrap mt-4">
            <a href="{{ path('app_serie_show', { id: album.serie.id }) }}" class="comic-action-btn">Retour</a>
        </div>

    </div>

</main>

{# --- Script prévisualisation image --- #}
<script>
document.addEventListener('DOMContentLoaded', () => {
    const fileInput = document.getElementById('album_image_input');
    const preview = document.getElementById('previewImage');
    const fileName = document.getElementById('fileName');

    if (!fileInput || !preview) return;

    // On garde l'URL actuelle pour fallback
    const originalSrc = preview.src;

    fileInput.addEventListener('change', () => {
        const file = fileInput.files[0];
        if (!file) {
            preview.src = originalSrc;
            preview.style.display = originalSrc ? 'block' : 'none';
            if (fileName) fileName.textContent = 'Aucun fichier choisi';
            return;
        }

        if (fileName) fileName.textContent = `Fichier sélectionné : ${file.name}`;

        // Utilisation d'une URL temporaire pour affichage instantané
        preview.src = URL.createObjectURL(file);
        preview.style.display = 'block';
    });
});
</script>

{% endblock %}
